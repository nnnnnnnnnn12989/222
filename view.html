<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>View — Hero to Zero</title>
  <style>
    :root{ --bg1:#1e3c72; --bg2:#2a5298; --white:#fff; --card:rgba(255,255,255,.06); --border:rgba(255,255,255,.14); }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font:500 16px/1.5 system-ui,Segoe UI,Roboto,Inter,Arial; color:var(--white);
      background:linear-gradient(135deg,var(--bg1),var(--bg2));
      display:flex; align-items:center; justify-content:center; padding:20px;
    }
    .wrap{width:100%; max-width:720px}
    h1{margin:0 0 18px; text-align:center; font-size:clamp(24px,4vw,36px)}
    .card{background:var(--card); border:1px solid var(--border); border-radius:16px; padding:18px;}
    label{font-size:14px; opacity:.9}
    select{
      width:100%; padding:12px 14px; border-radius:12px;
      border:1px solid var(--border); background:#0b1b26; color:#e5e7eb; font-size:16px;
    }
    .tableWrap{margin-top:20px; max-height:400px; overflow-y:auto}
    h2{margin-top:20px; font-size:20px; border-bottom:1px solid rgba(255,255,255,.2); padding-bottom:6px}
    h3{margin-top:12px; font-size:16px; opacity:.85}
    table{width:100%; border-collapse:collapse; margin-top:10px}
    th,td{padding:10px; border-bottom:1px dotted rgba(255,255,255,.15); text-align:left}
    th{font-size:14px; opacity:.85}
    .back{margin-top:12px; text-align:center; font-size:14px; opacity:.9}
    .back a{color:#e5e7eb; text-decoration:underline}
  </style>
</head>
<body>
  <main class="wrap">
    <h1>Choose Your Team</h1>
    <section class="card">
      <label for="teamSel">Teams</label>
      <select id="teamSel">
        <option value="">-- Select Team --</option>
        <option>Team 1</option><option>Team 2</option><option>Team 3</option>
        <option>Team 4</option><option>Team 5</option><option>Team 6</option>
        <option>Team 7</option><option>Team 8</option><option>Team 9</option>
        <option>Team 10</option>
      </select>

      <div id="tableWrap" class="tableWrap" style="display:none">
        <!-- Friday section -->
        <h2>Friday</h2>
        <h3>Station</h3>
        <table id="fridayStationTbl"><thead><tr><th>Game</th><th>Score</th></tr></thead><tbody></tbody></table>
        <h3>Carnival</h3>
        <table id="fridayCarnivalTbl"><thead><tr><th>Name</th><th>Score</th></tr></thead><tbody></tbody></table>
        <h3>Haflet el Summer</h3>
        <table id="fridayHafletTbl"><thead><tr><th>Name</th><th>Score</th></tr></thead><tbody></tbody></table>
        <h3>Mahfozat</h3>
        <table id="fridayMahfozatTbl"><thead><tr><th>Name</th><th>Score</th></tr></thead><tbody></tbody></table>

        <!-- Saturday section -->
        <h2>Saturday</h2>
        <h3>Station</h3>
        <table id="satStationTbl"><thead><tr><th>Game</th><th>Score</th></tr></thead><tbody></tbody></table>
        <h3>Kenz</h3>
        <table id="satKenzTbl"><thead><tr><th>Name</th><th>Score</th></tr></thead><tbody></tbody></table>
        <h3>Mahfoozat</h3>
        <table id="satMahfoozatTbl"><thead><tr><th>Name</th><th>Score</th></tr></thead><tbody></tbody></table>
      </div>
    </section>
    <!-- Always go back to index -->
    <p class="back"><a href="index.html">← Back</a></p>
  </main>

<script>
const ENDPOINT = localStorage.getItem('H2Z_ENDPOINT') 
  || 'https://script.google.com/macros/s/AKfycbyDxltzhBGlSsbZrttqIhmh3z_tiVcBZ7A1Obepw3vuxRLtb7WhtXVpa6xGSrzI7xjC/exec';

const teamSel = document.getElementById('teamSel');
const tableWrap = document.getElementById('tableWrap');

const fridayStationTbl = document.querySelector('#fridayStationTbl tbody');
const fridayCarnivalTbl = document.querySelector('#fridayCarnivalTbl tbody');
const fridayHafletTbl   = document.querySelector('#fridayHafletTbl tbody');
const fridayMahfozatTbl = document.querySelector('#fridayMahfozatTbl tbody');

const satStationTbl     = document.querySelector('#satStationTbl tbody');
const satKenzTbl        = document.querySelector('#satKenzTbl tbody');
const satMahfoozatTbl   = document.querySelector('#satMahfoozatTbl tbody');

// --- Helpers ---
function clearTables(){
  [fridayStationTbl, fridayCarnivalTbl, fridayHafletTbl, fridayMahfozatTbl,
   satStationTbl, satKenzTbl, satMahfoozatTbl].forEach(t => t.innerHTML = '');
}

// Supports both capitalized (Day/Game/Team/Score) and lowercase keys just in case.
function keyOf(row, k){
  return row[k] ?? row[k.toLowerCase()];
}

// Keep the latest entry for each (Day|Game|Team). Assumes sheet appends new rows.
function latestByKey(rows){
  const m = new Map();
  rows.forEach(r => {
    const day  = keyOf(r, 'Day');
    const game = keyOf(r, 'Game');
    const team = keyOf(r, 'Team');
    const k = `${day}|${game}|${team}`;
    m.set(k, r);
  });
  return Array.from(m.values());
}

async function fetchRows(){
  const res = await fetch(ENDPOINT, { method: 'GET' });
  if(!res.ok) throw new Error('Failed to load data');
  const data = await res.json();  // [{Day, Game, Team, Score}, ...]
  return latestByKey(data);
}

function fillForTeam(rows, team){
  clearTables();

  // ----- FRIDAY -----
  // Station: 10 games Station-Game1..10
  for(let g=1; g<=10; g++){
    const label = `Station-Game${g}`;
    const entry = rows.find(r => keyOf(r,'Day')==='Friday' && keyOf(r,'Game')===label && keyOf(r,'Team')===team);
    fridayStationTbl.innerHTML += `<tr><td>Game ${g}</td><td>${entry ? keyOf(entry,'Score') : '-'}</td></tr>`;
  }
  // Carnival
  {
    const e = rows.find(r => keyOf(r,'Day')==='Friday' && keyOf(r,'Game')==='Carnival' && keyOf(r,'Team')===team);
    fridayCarnivalTbl.innerHTML = `<tr><td>Carnival</td><td>${e ? keyOf(e,'Score') : '-'}</td></tr>`;
  }
  // Haflet el Summer
  {
    const e = rows.find(r => keyOf(r,'Day')==='Friday' && keyOf(r,'Game')==='Haflet el Summer' && keyOf(r,'Team')===team);
    fridayHafletTbl.innerHTML = `<tr><td>Haflet el Summer</td><td>${e ? keyOf(e,'Score') : '-'}</td></tr>`;
  }
  // Mahfozat
  {
    const e = rows.find(r => keyOf(r,'Day')==='Friday' && keyOf(r,'Game')==='Mahfozat' && keyOf(r,'Team')===team);
    fridayMahfozatTbl.innerHTML = `<tr><td>Mahfozat</td><td>${e ? keyOf(e,'Score') : '-'}</td></tr>`;
  }

  // ----- SATURDAY -----
  // Station: 5 games
  for(let g=1; g<=5; g++){
    const label = `Station-Game${g}`;
    const entry = rows.find(r => keyOf(r,'Day')==='Saturday' && keyOf(r,'Game')===label && keyOf(r,'Team')===team);
    satStationTbl.innerHTML += `<tr><td>Game ${g}</td><td>${entry ? keyOf(entry,'Score') : '-'}</td></tr>`;
  }
  // Kenz
  {
    const e = rows.find(r => keyOf(r,'Day')==='Saturday' && keyOf(r,'Game')==='Kenz' && keyOf(r,'Team')===team);
    satKenzTbl.innerHTML = `<tr><td>Kenz</td><td>${e ? keyOf(e,'Score') : '-'}</td></tr>`;
  }
  // Mahfoozat  (double “o” to match your View labels)
  {
    const e = rows.find(r => keyOf(r,'Day')==='Saturday' && keyOf(r,'Game')==='Mahfoozat' && keyOf(r,'Team')===team);
    satMahfoozatTbl.innerHTML = `<tr><td>Mahfoozat</td><td>${e ? keyOf(e,'Score') : '-'}</td></tr>`;
  }
}

// --- Hook up UI ---
let cache = null;

teamSel.addEventListener('change', async () => {
  const team = teamSel.value;
  if(!team){ tableWrap.style.display = 'none'; return; }

  tableWrap.style.display = 'block';

  // Load once and cache (sheet is append-only; refresh page to refetch)
  if(!cache){
    try {
      cache = await fetchRows();
    } catch (err) {
      console.error(err);
      alert('Could not load scores. Check your internet or the sheet deployment permissions.');
      tableWrap.style.display = 'none';
      return;
    }
  }
  fillForTeam(cache, team);
});
</script>

</body>
</html>
